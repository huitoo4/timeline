<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mi Timeline</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white h-screen overflow-hidden">

<div class="flex flex-col h-full">

  <!-- barra superior -->
  <div class="p-4 border-b flex justify-between items-center">
    <h1 class="text-xl font-bold">Mi Timeline</h1>
    <button id="addEventBtn" title="Nuevo evento" class="bg-black text-white px-4 py-2 rounded">+</button>
    <label class="ml-4 flex items-center gap-2">
      Color barra:
      <input type="color" id="timelineColorPicker" value="#000000" title="Cambiar color de la barra del timeline">
    </label>
  </div>

  <!-- zoom slider -->
  <div class="p-2 flex items-center gap-2">
    <span class="text-sm">Zoom</span>
    <input id="zoomSlider" title="Controla el nivel de zoom" type="range" min="1" max="5" step="0.1" value="1" class="w-full">
  </div>

  <!-- timeline -->
  <div id="timelineContainer" class="flex-1 overflow-x-scroll relative px-32">
    <div id="timelineWrapper" class="relative h-full flex items-center">
      <div id="timeline" class="h-1 bg-black origin-center"></div>
      <div id="startDate" class="absolute left-0 top-1/2 -translate-y-8 text-sm text-gray-600">Inicio</div>
      <div id="endDate" class="absolute right-0 top-1/2 -translate-y-8 text-sm text-gray-600">Hoy</div>
    </div>
  </div>

</div>

<!-- modal pedir fecha de nacimiento -->
<div id="birthModal" class="fixed inset-0 bg-black/40 flex items-center justify-center">
  <div class="bg-white p-6 rounded shadow w-96">
    <h2 class="text-lg font-bold mb-4">Introduce tu fecha de nacimiento</h2>
    <input id="birthDateInput" type="date" class="border p-2 w-full mb-4">
    <button id="saveBirthDate" class="bg-black text-white px-4 py-2 rounded w-full">Guardar</button>
  </div>
</div>

<!-- modal añadir evento -->
<div id="eventModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
  <div class="bg-white p-6 rounded shadow w-96">
    <h2 class="text-lg font-bold mb-2">Nuevo evento</h2>
    <input id="eventTitle" placeholder="Título" class="border p-2 w-full mb-2">
    <input id="eventDate" type="month" class="border p-2 w-full mb-4">
    <button id="saveEvent" class="bg-black text-white px-4 py-2 rounded">Guardar</button>
  </div>
</div>

<!-- modal ver/editar evento -->
<div id="viewModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
  <div class="bg-white p-6 rounded shadow w-[500px] max-h-[80vh] overflow-auto">
    <h2 id="viewTitle" class="text-xl font-bold"></h2>
    <p id="viewDate" class="text-sm text-gray-500 mb-2"></p>

    <textarea id="viewDesc" class="border p-2 w-full mb-2" placeholder="Descripción..."></textarea>

    <input id="photoInput" type="file" accept="image/*" class="mb-2">
    <div id="photoContainer" class="flex gap-2 flex-wrap"></div>

    <button id="closeView" class="mt-4 bg-black text-white px-4 py-2 rounded">Cerrar</button>
  </div>
</div>

<script>
let events = JSON.parse(localStorage.getItem("timelineEvents") || "[]");
const timeline = document.getElementById("timeline");
const wrapper = document.getElementById("timelineWrapper");
const colorPicker = document.getElementById("timelineColorPicker");
const startDateEl = document.getElementById("startDate");
const endDateEl = document.getElementById("endDate");

// cargar color guardado
let savedTimelineColor = localStorage.getItem("timelineColor");
if(savedTimelineColor){
  timeline.style.backgroundColor = savedTimelineColor;
  colorPicker.value = savedTimelineColor;
}

// pedir fecha de nacimiento si no está
let birthDate = localStorage.getItem("birthDate");
const birthModal = document.getElementById("birthModal");
if(!birthDate){
  birthModal.classList.add("flex");
} else {
  birthModal.classList.remove("flex");
  birthModal.classList.add("hidden");
  startDateEl.innerText = formatDate(birthDate);
}

// guardar fecha de nacimiento
document.getElementById("saveBirthDate").onclick = () => {
  const input = document.getElementById("birthDateInput").value;
  if(!input) return;
  birthDate = input;
  localStorage.setItem("birthDate", birthDate);
  startDateEl.innerText = formatDate(birthDate);

  // cerrar modal correctamente
  birthModal.classList.add("hidden");
  birthModal.classList.remove("flex");
};

// formatear fecha para mostrar
function formatDate(dateStr){
  const d = new Date(dateStr);
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  return d.toLocaleDateString('es-ES', options);
}

function saveEvents() {
  localStorage.setItem("timelineEvents", JSON.stringify(events));
}

function renderTimeline() {
  timeline.innerHTML = "";
  const baseWidth = 3000;
  timeline.style.width = baseWidth + "px";

  if(events.length === 0) return;

  const start = new Date(birthDate).getTime();
  const end = new Date().getTime();

  events.forEach(ev => {
    const evTime = new Date(ev.date).getTime();
    const percent = (evTime - start) / (end - start);
    const left = percent * (baseWidth - 200) + 100;

    const dot = document.createElement("div");
    dot.className = "absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-black rounded-full cursor-pointer";
    dot.style.left = left + "px";

    const label = document.createElement("div");
    label.className = "absolute -top-10 text-xs text-center w-40 -translate-x-1/2";
    label.innerText = ev.title + "\\n" + ev.date;

    dot.appendChild(label);
    dot.onclick = () => openView(ev);

    timeline.appendChild(dot);
  });
}

renderTimeline();

document.getElementById("addEventBtn").onclick = () => {
  eventModal.classList.remove("hidden");
  eventModal.classList.add("flex");
};

document.getElementById("saveEvent").onclick = () => {
  const title = eventTitle.value;
  const date = eventDate.value;
  if (!title || !date) return;

  events.push({ id: Date.now(), title, date, desc: "", photos: [] });
  saveEvents();
  renderTimeline();

  eventTitle.value = "";
  eventDate.value = "";
  eventModal.classList.add("hidden");
};

function openView(ev) {
  viewModal.classList.remove("hidden");
  viewModal.classList.add("flex");

  viewTitle.innerText = ev.title;
  viewDate.innerText = ev.date;
  viewDesc.value = ev.desc || "";

  photoContainer.innerHTML = "";
  ev.photos.forEach(p => {
    const img = document.createElement("img");
    img.src = p;
    img.className = "w-24 h-24 object-cover rounded";
    photoContainer.appendChild(img);
  });

  viewDesc.oninput = () => {
    ev.desc = viewDesc.value;
    saveEvents();
  };

  photoInput.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      ev.photos.push(reader.result);
      saveEvents();
      openView(ev);
    };
    reader.readAsDataURL(file);
  };
}

document.getElementById("closeView").onclick = () => {
  viewModal.classList.add("hidden");
};

// selector color barra
colorPicker.addEventListener("input", e => {
  const color = e.target.value;
  timeline.style.backgroundColor = color;
  localStorage.setItem("timelineColor", color);
});

const zoomSlider = document.getElementById("zoomSlider");
let scale = 1;

function applyZoom() {
  timeline.style.transform = "scaleX(" + scale + ")";
  timeline.style.transformOrigin = "center";
}

zoomSlider.oninput = e => {
  scale = e.target.value;
  applyZoom();
};

// zoom con scroll
document.getElementById("timelineContainer").addEventListener("wheel", e => {
  if (!e.ctrlKey) return;
  e.preventDefault();
  scale += e.deltaY * -0.001;
  scale = Math.min(5, Math.max(1, scale));
  zoomSlider.value = scale;
  applyZoom();
}, { passive: false });

// poner fecha final como hoy
endDateEl.innerText = formatDate(new Date().toISOString().split('T')[0]);
</script>

</body>
</html>
